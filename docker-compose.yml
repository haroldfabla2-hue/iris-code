version: '3.8'

# =============================================================================
# IRIS CODE ENHANCED - CON FRAMEWORK SILHOUETTE V4.0 INTEGRADO
# Sistema Multi-Agente Empresarial Completo con Fallback Inteligente
# =============================================================================

services:
  # =============================================================================
  # INFRAESTRUCTURA BASE IRIS CODE
  # =============================================================================
  iris-backend:
    build:
      context: .
      dockerfile: src/backend/Dockerfile
    container_name: iris-backend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DOMAIN=iris-code.albertofarah.com
      - FRAMEWORK_VERSION=4.0.0
    env_file:
      - .env.production
    volumes:
      - ./logs:/var/log/iris-code
      - ./uploads:/app/uploads
    networks:
      - iris-network
      - silhouette-network
      - n8n-network
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  iris-frontend:
    build:
      context: ./src/frontend
      dockerfile: Dockerfile
    container_name: iris-frontend
    restart: unless-stopped
    ports:
      - "3001:80"
    environment:
      - VITE_API_URL=https://iris-code.albertofarah.com/api
      - VITE_WS_URL=wss://iris-code.albertofarah.com/ws
      - VITE_SILHOUETTE_URL=https://iris-code.albertofarah.com/silhouette
    networks:
      - iris-network
      - silhouette-network

  # =============================================================================
  # SERVIDOR DE FALLBACK IRIS CODE - PUERTO 8021
  # =============================================================================
  iris-fallback-server:
    build:
      context: ./src/fallback-server
      dockerfile: Dockerfile
    container_name: iris-fallback-server
    restart: unless-stopped
    ports:
      - "8021:8021"
    environment:
      - NODE_ENV=production
      - FALLBACK_PORT=8021
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - FREEPIK_API_KEY=${FREEPIK_API_KEY}
      - VEO3_API_KEY=${VEO3_API_KEY}
      - HUGGINGFACE_TOKEN=${HUGGINGFACE_TOKEN}
    env_file:
      - .env.production
    volumes:
      - ./logs/fallback:/app/logs
    networks:
      - iris-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8021/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =============================================================================
  # API GATEWAY UNIFICADO - PUERTO PRINCIPAL 8020
  # =============================================================================
  api-gateway:
    build:
      context: ./src/api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    restart: unless-stopped
    ports:
      - "8020:8020"
    environment:
      - NODE_ENV=production
      - GATEWAY_PORT=8020
      - FALLBACK_PORT=8021
      - SILHOUETTE_PORT=8022
      - ASSETS_PORT=8023
      - MCP_PORT=8027
      - CONTEXT_BRIDGE_PORT=8104
      - CONTEXT_CAPTURE_PORT=8100
      - CONTEXT_RETRIEVAL_PORT=8102
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173,http://localhost:3001
    env_file:
      - .env.production
    volumes:
      - ./logs/api-gateway:/app/logs
      - ./data/gateway:/app/data
    networks:
      - iris-network
      - silhouette-network
      - mcp-network
      - iris-context-network
    depends_on:
      - postgres
      - redis
      - iris-backend
      - silhouette-orchestrator
      - context-bridge
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8020/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =============================================================================
  # COMPONENTES CORE DEL FRAMEWORK SILHOUETTE V4.0
  # =============================================================================
  silhouette-orchestrator:
    build:
      context: ./src/silhouette/orchestrator
      dockerfile: Dockerfile
    container_name: silhouette-orchestrator
    restart: unless-stopped
    ports:
      - "8030:8030"
    environment:
      - NODE_ENV=production
      - ORCHESTRATOR_PORT=8030
      - ORCHESTRATOR_HOST=0.0.0.0
      - TASK_QUEUE_SIZE=10000
      - FRAMEWORK_VERSION=4.0.0
    env_file:
      - .env.production
    volumes:
      - ./logs/orchestrator:/var/log/silhouette/orchestrator
      - ./data/orchestrator:/app/data
    networks:
      - silhouette-network
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  silhouette-planner:
    build:
      context: ./src/silhouette/planner
      dockerfile: Dockerfile
    container_name: silhouette-planner
    restart: unless-stopped
    ports:
      - "8025:8025"
    environment:
      - NODE_ENV=production
      - PLANNER_PORT=8025
      - PLANNER_WORKERS=4
      - WORKFLOW_CACHE_SIZE=1000
      - FRAMEWORK_VERSION=4.0.0
    env_file:
      - .env.production
    volumes:
      - ./logs/planner:/var/log/silhouette/planner
      - ./data/planner:/app/data
    networks:
      - silhouette-network
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8025/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  silhouette-optimization-team:
    build:
      context: ./src/silhouette/optimization-team
      dockerfile: Dockerfile
    container_name: silhouette-optimization-team
    restart: unless-stopped
    ports:
      - "8033:8033"
    environment:
      - NODE_ENV=production
      - OPTIMIZATION_PORT=8033
      - LEARNING_RATE=0.001
      - OPTIMIZATION_INTERVAL=30000
      - FRAMEWORK_VERSION=4.0.0
    env_file:
      - .env.production
    volumes:
      - ./logs/optimization:/var/log/silhouette/optimization
      - ./data/optimization:/app/data
    networks:
      - silhouette-network
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8033/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  silhouette-mcp-server:
    build:
      context: ./src/silhouette/mcp-server
      dockerfile: Dockerfile
    container_name: silhouette-mcp-server
    restart: unless-stopped
    ports:
      - "8027:8027"
    environment:
      - NODE_ENV=production
      - MCP_SERVER_PORT=8027
      - API_RATE_LIMIT=1000
      - FRAMEWORK_VERSION=4.0.0
    env_file:
      - .env.production
    volumes:
      - ./logs/mcp-server:/var/log/silhouette/mcp-server
      - ./data/mcp-server:/app/data
    networks:
      - silhouette-network
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8027/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # EQUIPOS EMPRESARIALES PRINCIPALES (25+ equipos) - Puertos 8000-8024
  # =============================================================================
  business-development-team:
    build:
      context: ./src/silhouette/teams/business/business_development_team
      dockerfile: Dockerfile
    container_name: business-development-team
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=business
      - TEAM_NAME=business_development_team
    env_file:
      - .env.production
    volumes:
      - ./logs/teams:/var/log/silhouette/teams
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  marketing-team:
    build:
      context: ./src/silhouette/teams/business/marketing_team
      dockerfile: Dockerfile
    container_name: marketing-team
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=business
      - TEAM_NAME=marketing_team
    env_file:
      - .env.production
    volumes:
      - ./logs/teams:/var/log/silhouette/teams
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  sales-team:
    build:
      context: ./src/silhouette/teams/business/sales_team
      dockerfile: Dockerfile
    container_name: sales-team
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=business
      - TEAM_NAME=sales_team
    env_file:
      - .env.production
    volumes:
      - ./logs/teams:/var/log/silhouette/teams
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  finance-team:
    build:
      context: ./src/silhouette/teams/business/finance_team
      dockerfile: Dockerfile
    container_name: finance-team
    restart: unless-stopped
    ports:
      - "8003:8003"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=business
      - TEAM_NAME=finance_team
    env_file:
      - .env.production
    volumes:
      - ./logs/teams:/var/log/silhouette/teams
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  hr-team:
    build:
      context: ./src/silhouette/teams/business/hr_team
      dockerfile: Dockerfile
    container_name: hr-team
    restart: unless-stopped
    ports:
      - "8004:8004"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=business
      - TEAM_NAME=hr_team
    env_file:
      - .env.production
    volumes:
      - ./logs/teams:/var/log/silhouette/teams
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  legal-team:
    build:
      context: ./src/silhouette/teams/business/legal_team
      dockerfile: Dockerfile
    container_name: legal-team
    restart: unless-stopped
    ports:
      - "8005:8005"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=business
      - TEAM_NAME=legal_team
    env_file:
      - .env.production
    volumes:
      - ./logs/teams:/var/log/silhouette/teams
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  strategy-team:
    build:
      context: ./src/silhouette/teams/business/strategy_team
      dockerfile: Dockerfile
    container_name: strategy-team
    restart: unless-stopped
    ports:
      - "8006:8006"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=business
      - TEAM_NAME=strategy_team
    env_file:
      - .env.production
    volumes:
      - ./logs/teams:/var/log/silhouette/teams
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  product-management-team:
    build:
      context: ./src/silhouette/teams/business/product_management_team
      dockerfile: Dockerfile
    container_name: product-management-team
    restart: unless-stopped
    ports:
      - "8007:8007"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=business
      - TEAM_NAME=product_management_team
    env_file:
      - .env.production
    volumes:
      - ./logs/teams:/var/log/silhouette/teams
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  research-team:
    build:
      context: ./src/silhouette/teams/business/research_team
      dockerfile: Dockerfile
    container_name: research-team
    restart: unless-stopped
    ports:
      - "8008:8008"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=business
      - TEAM_NAME=research_team
    env_file:
      - .env.production
    volumes:
      - ./logs/teams:/var/log/silhouette/teams
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  design-creative-team:
    build:
      context: ./src/silhouette/teams/business/design_creative_team
      dockerfile: Dockerfile
    container_name: design-creative-team
    restart: unless-stopped
    ports:
      - "8009:8009"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=business
      - TEAM_NAME=design_creative_team
    env_file:
      - .env.production
    volumes:
      - ./logs/teams:/var/log/silhouette/teams
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # SISTEMA AUDIOVISUAL (15+ equipos) - Puertos 8065-8075
  # =============================================================================
  image-search-team:
    build:
      context: ./src/silhouette/teams/audiovisual/image_search_team
      dockerfile: Dockerfile
    container_name: image-search-team
    restart: unless-stopped
    ports:
      - "8065:8000"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=audiovisual
      - TEAM_NAME=image_search_team
      - UNSPLASH_ACCESS_KEY=${UNSPLASH_ACCESS_KEY}
    env_file:
      - .env.production
    volumes:
      - ./logs/audiovisual:/var/log/silhouette/audiovisual
      - ./data/images:/app/images
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  animation-prompt-generator:
    build:
      context: ./src/silhouette/teams/audiovisual/animation_prompt_generator
      dockerfile: Dockerfile
    container_name: animation-prompt-generator
    restart: unless-stopped
    ports:
      - "8066:8000"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=audiovisual
      - TEAM_NAME=animation_prompt_generator
      - VIDEO_AI_PROVIDER=${VIDEO_AI_PROVIDER:-runway}
    env_file:
      - .env.production
    volumes:
      - ./logs/audiovisual:/var/log/silhouette/audiovisual
      - ./data/animations:/app/animations
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  video-scene-composer:
    build:
      context: ./src/silhouette/teams/audiovisual/video_scene_composer
      dockerfile: Dockerfile
    container_name: video-scene-composer
    restart: unless-stopped
    ports:
      - "8067:8000"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=audiovisual
      - TEAM_NAME=video_scene_composer
      - QUALITY_THRESHOLD=${QUALITY_THRESHOLD:-90}
    env_file:
      - .env.production
    volumes:
      - ./logs/audiovisual:/var/log/silhouette/audiovisual
      - ./data/videos:/app/videos
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  professional-script-generator:
    build:
      context: ./src/silhouette/teams/audiovisual/professional_script_generator
      dockerfile: Dockerfile
    container_name: professional-script-generator
    restart: unless-stopped
    ports:
      - "8068:8000"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=audiovisual
      - TEAM_NAME=professional_script_generator
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    env_file:
      - .env.production
    volumes:
      - ./logs/audiovisual:/var/log/silhouette/audiovisual
      - ./data/scripts:/app/scripts
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # WORKFLOWS DINÁMICOS ESPECIALIZADOS (45+ equipos) - Puertos 8034-8077
  # =============================================================================
  compliance-team:
    build:
      context: ./src/silhouette/teams/dynamic/compliance_team
      dockerfile: Dockerfile
    container_name: compliance-team
    restart: unless-stopped
    ports:
      - "8034:8000"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=dynamic
      - TEAM_NAME=compliance_team
    env_file:
      - .env.production
    volumes:
      - ./logs/dynamic:/var/log/silhouette/dynamic
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  cybersecurity-team:
    build:
      context: ./src/silhouette/teams/dynamic/cybersecurity_team
      dockerfile: Dockerfile
    container_name: cybersecurity-team
    restart: unless-stopped
    ports:
      - "8035:8000"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=dynamic
      - TEAM_NAME=cybersecurity_team
    env_file:
      - .env.production
    volumes:
      - ./logs/dynamic:/var/log/silhouette/dynamic
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  data-engineering-team:
    build:
      context: ./src/silhouette/teams/dynamic/data_engineering_team
      dockerfile: Dockerfile
    container_name: data-engineering-team
    restart: unless-stopped
    ports:
      - "8036:8000"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=dynamic
      - TEAM_NAME=data_engineering_team
    env_file:
      - .env.production
    volumes:
      - ./logs/dynamic:/var/log/silhouette/dynamic
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  ecommerce-team:
    build:
      context: ./src/silhouette/teams/dynamic/ecommerce_team
      dockerfile: Dockerfile
    container_name: ecommerce-team
    restart: unless-stopped
    ports:
      - "8037:8000"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=dynamic
      - TEAM_NAME=ecommerce_team
    env_file:
      - .env.production
    volumes:
      - ./logs/dynamic:/var/log/silhouette/dynamic
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  healthcare-team:
    build:
      context: ./src/silhouette/teams/dynamic/healthcare_team
      dockerfile: Dockerfile
    container_name: healthcare-team
    restart: unless-stopped
    ports:
      - "8038:8000"
    environment:
      - TEAM_PORT=8000
      - TEAM_TYPE=dynamic
      - TEAM_NAME=healthcare_team
    env_file:
      - .env.production
    volumes:
      - ./logs/dynamic:/var/log/silhouette/dynamic
    networks:
      - silhouette-network
    depends_on:
      - silhouette-orchestrator
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # BASE DE DATOS - PostgreSQL
  # =============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: iris-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=iris_user
      - POSTGRES_PASSWORD=IrisSecure2025@Production
      - POSTGRES_DB=iris_production_db
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --locale=C
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
      - ./scripts/postgres-init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./scripts/silhouette/init-silhouette-db.sql:/docker-entrypoint-initdb.d/silhouette-init.sql
    ports:
      - "5432:5432"
    networks:
      - iris-network
      - silhouette-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U iris_user -d iris_production_db"]
      interval: 30s
      timeout: 10s
      retries: 5

  # =============================================================================
  # CACHE - Redis
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: iris-redis
    restart: unless-stopped
    command: redis-server --requirepass RedisSecure2025@Cache --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - iris-network
      - silhouette-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # =============================================================================
  # CONTEXT MEMORY INFRASTRUCTURE - Sistema de Memoria Trans-Sesional
  # 8 Servicios: PostgreSQL+pgvector, Neo4j, Redis, Kafka, Context Services
  # =============================================================================
  
  # PostgreSQL with pgvector for vector similarity search
  iris-postgres-context:
    image: pgvector/pgvector:pg15
    container_name: iris-postgres-v2
    environment:
      POSTGRES_DB: iris_context_db
      POSTGRES_USER: iris_user
      POSTGRES_PASSWORD: IrisSecure2025@Context
    volumes:
      - iris_postgres_context_data:/var/lib/postgresql/data
      - ./services/database/init:/docker-entrypoint-initdb.d
    ports:
      - "5433:5432"
    networks:
      - iris-context-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U iris_user -d iris_context_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Neo4j for knowledge graphs
  iris-neo4j:
    image: neo4j:5.13-community
    container_name: iris-neo4j-v2
    environment:
      NEO4J_AUTH: neo4j/iris_secure_2025
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_memory_heap_initial__size: 2g
      NEO4J_dbms_memory_heap_max__size: 4g
      NEO4J_dbms_memory_pagecache_size: 1g
    volumes:
      - iris_neo4j_data:/data
      - iris_neo4j_logs:/logs
      - iris_neo4j_plugins:/plugins
    ports:
      - "7475:7474"
      - "7688:7687"
    networks:
      - iris-context-network
    healthcheck:
      test: ["CMD", "neo4j", "check"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for caching and session management
  iris-redis-context:
    image: redis:7.2-alpine
    container_name: iris-redis-v2
    command: redis-server --requirepass RedisSecure2025@Context
    volumes:
      - iris_redis_context_data:/data
    ports:
      - "6380:6379"
    networks:
      - iris-context-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Apache Kafka for event streaming
  iris-zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: iris-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - iris-context-network
    healthcheck:
      test: ["CMD", "sh", "-c", "echo ruok | nc localhost 2181 | grep imok"]
      interval: 10s
      timeout: 3s
      retries: 5

  iris-kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: iris-kafka
    depends_on:
      - iris-zookeeper
    ports:
      - "9093:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: iris-zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://iris-kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_NUM_PARTITIONS: 6
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_RETENTION_BYTES: 1073741824
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - iris-context-network
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Context Capture Service
  context-capture:
    build:
      context: ./services/services/context-capture
      dockerfile: Dockerfile
    container_name: iris-context-capture
    depends_on:
      - iris-kafka
      - iris-postgres-context
    environment:
      - KAFKA_BROKERS=iris-kafka:9092
      - DATABASE_URL=postgresql://iris_user:IrisSecure2025@iris-postgres-context:5432/iris_context_db
      - REDIS_URL=redis://:RedisSecure2025@iris-redis-context:6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    ports:
      - "8100:8001"
    networks:
      - iris-context-network
    volumes:
      - ./services/services/context-capture:/app
      - iris_context_capture_logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Context Processing Pipeline
  context-processing:
    build:
      context: ./services/services/context-processing
      dockerfile: Dockerfile
    container_name: iris-context-processing
    depends_on:
      - iris-kafka
      - iris-postgres-context
      - iris-neo4j
    environment:
      - KAFKA_BROKERS=iris-kafka:9092
      - DATABASE_URL=postgresql://iris_user:IrisSecure2025@iris-postgres-context:5432/iris_context_db
      - NEO4J_URI=bolt://iris-neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=iris_secure_2025
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    ports:
      - "8101:8002"
    networks:
      - iris-context-network
    volumes:
      - ./services/services/context-processing:/app
      - iris_context_processing_logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Context Retrieval Service
  context-retrieval:
    build:
      context: ./services/services/context-retrieval
      dockerfile: Dockerfile
    container_name: iris-context-retrieval
    depends_on:
      - iris-postgres-context
      - iris-neo4j
      - iris-redis-context
    environment:
      - DATABASE_URL=postgresql://iris_user:IrisSecure2025@iris-postgres-context:5432/iris_context_db
      - NEO4J_URI=bolt://iris-neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=iris_secure_2025
      - REDIS_URL=redis://:RedisSecure2025@iris-redis-context:6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    ports:
      - "8102:8003"
    networks:
      - iris-context-network
    volumes:
      - ./services/services/context-retrieval:/app
      - iris_context_retrieval_logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Memory Management Service
  memory-management:
    build:
      context: ./services/services/memory-management
      dockerfile: Dockerfile
    container_name: iris-memory-management
    depends_on:
      - iris-postgres-context
      - iris-redis-context
      - iris-kafka
    environment:
      - DATABASE_URL=postgresql://iris_user:IrisSecure2025@iris-postgres-context:5432/iris_context_db
      - REDIS_URL=redis://:RedisSecure2025@iris-redis-context:6379
      - KAFKA_BROKERS=iris-kafka:9092
    ports:
      - "8103:8004"
    networks:
      - iris-context-network
    volumes:
      - ./services/services/memory-management:/app
      - iris_memory_management_logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Context Bridge Service (NEW)
  context-bridge:
    build:
      context: ./src/services/context-bridge
      dockerfile: Dockerfile
    container_name: iris-context-bridge
    depends_on:
      - context-capture
      - context-retrieval
      - memory-management
    environment:
      - CONTEXT_CAPTURE_URL=http://context-capture:8001
      - CONTEXT_RETRIEVAL_URL=http://context-retrieval:8003
      - MEMORY_MANAGEMENT_URL=http://memory-management:8004
      - CONTEXT_BRIDGE_PORT=8104
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    ports:
      - "8104:8104"
    networks:
      - iris-context-network
      - silhouette-network
    volumes:
      - ./logs/context-bridge:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8104/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # MONITORING - Prometheus + Grafana
  # =============================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: iris-prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./monitoring/silhouette/prometheus-silhouette.yml:/etc/prometheus/prometheus-silhouette.yml
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - silhouette-network
    profiles:
      - monitoring

  grafana:
    image: grafana/grafana:latest
    container_name: iris-grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=IrisGrafana2025@
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=redis-datasource,postgres-datasource
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    ports:
      - "3002:3000"
    networks:
      - silhouette-network
    profiles:
      - monitoring

  # =============================================================================
  # NGINX - Reverse Proxy y Load Balancer
  # =============================================================================
  nginx:
    image: nginx:alpine
    container_name: iris-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/silhouette/nginx-silhouette.conf:/etc/nginx/nginx-silhouette.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./logs/nginx:/var/log/nginx
    networks:
      - iris-network
      - silhouette-network
      - n8n-network
    depends_on:
      - iris-backend
      - iris-frontend
      - silhouette-orchestrator
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

# =============================================================================
# VOLUMES PERSISTENTES
# =============================================================================
volumes:
  # IRIS Principal
  postgres_data:
    driver: local
  redis_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  
  # Context Memory Infrastructure
  iris_postgres_context_data:
    driver: local
  iris_neo4j_data:
    driver: local
  iris_neo4j_logs:
    driver: local
  iris_neo4j_plugins:
    driver: local
  iris_redis_context_data:
    driver: local
  iris_context_capture_logs:
    driver: local
  iris_context_processing_logs:
    driver: local
  iris_context_retrieval_logs:
    driver: local
  iris_memory_management_logs:
    driver: local

# =============================================================================
# REDES DOCKER
# =============================================================================
networks:
  iris-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  silhouette-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
  iris-context-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16
  mcp-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.23.0.0/16
  n8n-network:
    external: true
    name: n8n-network

# =============================================================================
# CONFIGURACIÓN DE RECURSOS
# =============================================================================
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "100m"
    max-file: "5"

x-restart-policy: &default-restart-policy
  restart: unless-stopped

x-healthcheck-defaults: &default-healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s