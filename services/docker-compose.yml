version: '3.8'

services:
  # PostgreSQL with pgvector for vector similarity search
  postgres:
    image: pgvector/pgvector:pg15
    container_name: iris-postgres-v2
    environment:
      POSTGRES_DB: iris_context_db
      POSTGRES_USER: iris_user
      POSTGRES_PASSWORD: IrisSecure2025@Context
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
    networks:
      - iris-context-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U iris_user -d iris_context_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Neo4j for knowledge graphs
  neo4j:
    image: neo4j:5.13-community
    container_name: iris-neo4j-v2
    environment:
      NEO4J_AUTH: neo4j/iris_secure_2025
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_memory_heap_initial__size: 2g
      NEO4J_dbms_memory_heap_max__size: 4g
      NEO4J_dbms_memory_pagecache_size: 1g
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_plugins:/plugins
    networks:
      - iris-context-network
    healthcheck:
      test: ["CMD", "neo4j", "check"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for caching and session management
  redis:
    image: redis:7.2-alpine
    container_name: iris-redis-v2
    command: redis-server --requirepass RedisSecure2025@Context
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - iris-context-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Apache Kafka for event streaming
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: iris-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - iris-context-network
    healthcheck:
      test: ["CMD", "sh", "-c", "echo ruok | nc localhost 2181 | grep imok"]
      interval: 10s
      timeout: 3s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: iris-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_NUM_PARTITIONS: 6
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_RETENTION_BYTES: 1073741824
      KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS: 300000
      KAFKA_LOG_RETENTION_SIZE: 1073741824
      KAFKA_LOG_SEGMENT_BYTES: 268435456
      KAFKA_LOG_INDEX_SIZE_MAX_BYTES: 10485760
      KAFKA_LOG_INDEX_INTERVAL_BYTES: 4096
    networks:
      - iris-context-network
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Context Capture Service
  context-capture:
    build:
      context: ./services/context-capture
      dockerfile: Dockerfile
    container_name: iris-context-capture
    depends_on:
      - kafka
      - postgres
    environment:
      - KAFKA_BROKERS=kafka:9092
      - DATABASE_URL=postgresql://iris_user:IrisSecure2025@postgres:5432/iris_context_db
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - REDIS_URL=redis://:RedisSecure2025@redis:6379
    ports:
      - "8001:8001"
    networks:
      - iris-context-network
    volumes:
      - ./services/context-capture:/app
      - context_capture_logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Context Processing Pipeline
  context-processing:
    build:
      context: ./services/context-processing
      dockerfile: Dockerfile
    container_name: iris-context-processing
    depends_on:
      - kafka
      - postgres
      - neo4j
    environment:
      - KAFKA_BROKERS=kafka:9092
      - DATABASE_URL=postgresql://iris_user:IrisSecure2025@postgres:5432/iris_context_db
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=iris_secure_2025
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    ports:
      - "8002:8002"
    networks:
      - iris-context-network
    volumes:
      - ./services/context-processing:/app
      - context_processing_logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Context Retrieval Service
  context-retrieval:
    build:
      context: ./services/context-retrieval
      dockerfile: Dockerfile
    container_name: iris-context-retrieval
    depends_on:
      - postgres
      - neo4j
      - redis
    environment:
      - DATABASE_URL=postgresql://iris_user:IrisSecure2025@postgres:5432/iris_context_db
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=iris_secure_2025
      - REDIS_URL=redis://:RedisSecure2025@redis:6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    ports:
      - "8003:8003"
    networks:
      - iris-context-network
    volumes:
      - ./services/context-retrieval:/app
      - context_retrieval_logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Memory Management Service
  memory-management:
    build:
      context: ./services/memory-management
      dockerfile: Dockerfile
    container_name: iris-memory-management
    depends_on:
      - postgres
      - redis
      - kafka
    environment:
      - DATABASE_URL=postgresql://iris_user:IrisSecure2025@postgres:5432/iris_context_db
      - REDIS_URL=redis://:RedisSecure2025@redis:6379
      - KAFKA_BROKERS=kafka:9092
    ports:
      - "8004:8004"
    networks:
      - iris-context-network
    volumes:
      - ./services/memory-management:/app
      - memory_management_logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
    driver: local
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_plugins:
    driver: local
  redis_data:
    driver: local
  context_capture_logs:
    driver: local
  context_processing_logs:
    driver: local
  context_retrieval_logs:
    driver: local
  memory_management_logs:
    driver: local

networks:
  iris-context-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16